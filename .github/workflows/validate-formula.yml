name: Validate Formula
run-name: Validate formula for ${{ github.event.inputs.version }}

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Expected fastskill version (e.g. 1.2.3)"
        required: true
        type: string

permissions:
  contents: read

jobs:
  validate:
    name: Validate on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-15-intel, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Resolve expected version
        id: expected
        shell: bash
        run: |
          set -euo pipefail
          EXPECTED="${{ github.event.inputs.version }}"
          EXPECTED="${EXPECTED#v}"
          echo "value=$EXPECTED" >> "$GITHUB_OUTPUT"
          echo "Expected version: $EXPECTED"

      - name: Tap branch from GitHub
        shell: bash
        run: |
          set -euo pipefail
          brew untap gofastskill/cli || true
          brew tap gofastskill/cli https://github.com/gofastskill/homebrew-cli --branch "${{ github.ref_name }}"
          brew tap

      - name: Audit formula
        shell: bash
        run: brew audit --strict gofastskill/cli/fastskill

      - name: Install formula
        shell: bash
        run: |
          set -euo pipefail
          brew install --build-from-source gofastskill/cli/fastskill

      - name: Verify installed version
        shell: bash
        run: |
          set -euo pipefail
          EXPECTED="${{ steps.expected.outputs.value }}"
          INSTALLED=$(fastskill --version | grep -oE '[0-9]+\.[0-9]+\.[0-9]+([-+][A-Za-z0-9.-]+)?' | head -1)

          if [ -z "$INSTALLED" ]; then
            echo "Unable to parse installed fastskill version"
            fastskill --version
            exit 1
          fi

          if [ "$INSTALLED" != "$EXPECTED" ]; then
            echo "Version mismatch: expected $EXPECTED, got $INSTALLED"
            exit 1
          fi

          echo "Installed fastskill version matches expected: $INSTALLED"
